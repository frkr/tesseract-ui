# Copyright (c) 2025 Davi Saranszky Mesquita. All rights reserved.
# See LICENSE for license information.

# Do not use 'workflow_dispatch'

name: Issue Run Labeler

on:
  schedule:
    # Run every 2 hours (at minute 0)
    - cron: '0 */2 * * *'

jobs:
  label_recent_issues:
    name: Label issues
    runs-on: ubuntu-latest
    steps:
      - name: Label open issues older than 2 hours with "run"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const now = Date.now();
            const threshold = new Date(now - 2 * 60 * 60 * 1000); // 2 hours ago
            const { owner, repo } = context.repo;

            // Fetch open issues (exclude PRs) and filter by creation time
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', per_page: 100 }
            );

            const candidates = issues.filter(i => !i.pull_request && new Date(i.created_at) <= threshold);

            core.info(`Found ${candidates.length} open issue(s) created`);

            for (const issue of candidates) {
              const existing = (issue.labels || []).map(l => typeof l === 'string' ? l : l.name);
              if (!existing.includes('run')) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: ['run'],
                });
                core.info(`Labeled #${issue.number} with "run".`);
              } else {
                core.info(`Issue #${issue.number} already labeled with "run". Skipping.`);
              }
            }
