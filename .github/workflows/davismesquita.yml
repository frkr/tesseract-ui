# Copyright (c) 2025 Davi Saranszky Mesquita. All rights reserved.
# See LICENSE for license information.

name: Casa Das IdÃ©ias

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  translation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          export PATH="$HOME/.cursor/bin:$PATH"
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Run Cursor Agent
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          export PATH="$HOME/.cursor/bin:$PATH"
          git config --local user.email "suporte@ideias.casa"
          git config --local user.name "AI"
          cursor-agent -p --model auto --force --output-format text "You have full access to git, GitHub CLI, and PR operations. You can also run any command you want.
          First, check the terminologies in the '/terminology.md' file and update '/messages' accordingly.
          Then, check all languages in the '/project.inlang' folder and check all translation messages in the '/messages' folder. Add new languages if necessary.
          The file 'src/routes/user/profile/+page.svelte' must have a way to change the language (add the same amount languages as in '/project.inlang' file).
          Validate translations using 'pnpm run paraglide:compile' and check if there are any errors and fix them.
          Finally, in the README.md you will find what language this project uses as the main language and create the 'summary' in that language.
          Do not create additional files like 'VALIDACAO_TRADUCOES.md' or 'SUMMARY_TRADUCAO.md'.
          If there are any changes, commit using the summary and push it."


  prettier:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: [translation, coverage]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run prettier
        run: pnpm prettier

      - name: Check for changes
        id: git-check
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "suporte@ideias.casa"
          git config --local user.name "Chore"
          git add .
          git commit -m "chore: prettier"
          git push


  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Cursor CLI
        run: |
         curl https://cursor.com/install -fsS | bash
         export PATH="$HOME/.cursor/bin:$PATH"
         echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Run Cursor Agent
        env:
         CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
         GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          export PATH="$HOME/.cursor/bin:$PATH"
          git config --local user.email "suporte@ideias.casa"
          git config --local user.name "AI"
          cursor-agent -p --model auto --force --output-format text "You have full access to git, GitHub CLI, and PR operations. You can also run any command you want.
          Inside the folder 'src' search for all files like '.server.ts' and this list:
          - src/lib/app.ts
          - src/lib/index.ts
          - src/lib/stores/**
          - src/lib/utils/**
          
          All those files must have 80% coverage. DO NOT CHANGE ANYTHING, just add the coverage adding '.spec.ts' files understanding what those files do (if you are not sure, do not try to coverage that)
          Finally, in the README.md you will find what language this project uses as the main language and create the 'summary' in that language.
          Do not create additional files like 'VALIDACAO_COVERAGE.md' or 'SUMMARY_COVERAGE.md'.
          If there are any changes, commit using the summary and push it."
