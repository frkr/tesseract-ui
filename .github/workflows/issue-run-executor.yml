# Copyright (c) 2025 Davi Saranszky Mesquita. All rights reserved.
# See LICENSE for license information.

# Do not use 'workflow_dispatch'

name: Issue Run Executor

on:
  issues:
    types: [labeled, unlabeled]

permissions:
  contents: read
  issues: write

jobs:
  triage_and_review:
    name: Run Cursor review when label 'run' is added
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.issue.labels.*.name, 'run') &&
      !contains(github.event.issue.labels.*.name, 'stop') &&
      !contains(github.event.issue.labels.*.name, 'code')

    steps:
      - name: Add 'stop' label to the issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: context.issue.number,
              labels: ['stop']
            });
            core.info('Added label "stop" to prevent duplicate processing.');

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          export PATH="$HOME/.cursor/bin:$PATH"
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Run Cursor Agent (issue triage and review)
        id: cursor
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          set -euo pipefail
          export PATH="$HOME/.cursor/bin:$PATH"
          cursor-agent -p --model auto --force --output-format text "You have full access to git, GitHub CLI, and PR operations. You can also run any command you want.
          Make a comment on this issue ${ISSUE_URL} and a review.
          Discover if it's an issue for a new feature, new documentation, a command or a bug.
          Comment with grammar corrections and/or improvements. If it's a Feature, observe the project guidelines on '/ai-guidelines.md'.
          Propose in detail all the functionalities to be implemented, which pages will be created and how they will be created. Create numerous flows made in mermaidjs using sequence diagrams and also propose modifications to the database schema. The objective, if it's a feature, is for the proposal to be very clear for the business at the beginning of the comment and to be very detailed for the developer to know how to proceed and which files they will create.
          Your summary will contain the same issue but with those corrections and improvements.
          Write a summary in the language discovered on /readme.md
          Treat that language as the main language. DO NOT CHANGE ANY FILES, this is only an issue review.
          IMPORTANT: Do NOT post the comment yourself. Output ONLY the final review in Markdown to stdout." > review.txt

      - name: Comment on the issue with the review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.txt', 'utf8');
            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Add 'code' label to the issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: context.issue.number,
                labels: ['code']
              });
              core.info('Added label "code".');
            } catch (error) {
              core.warning('Could not add label "code".');
            }



      - name: Remove label (cleanup)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: context.issue.number,
                name: 'stop'
              });
              core.info('Removed label "stop".');
            } catch (error) {
              core.warning('Could not remove label "stop" (it may have been removed already).');
            }
